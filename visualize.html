<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Point-Reader 可视化工具</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --accent-dark: #064e3b;
      --accent-hover: #065f46;
      --accent-border: #14532d;
      --danger: #ef4444;
      --border: #334155;
      --input-bg: #020617;
      --btn: #1f2937;
      --btn-hover: #374151;
      --focus-ring: rgba(59, 130, 246, 0.4);
    }
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(circle at 1px 1px, rgba(200, 200, 200, 0.1) 1px, transparent 0);
      background-size: 24px 24px;
      color: var(--text);
      min-height: 100vh;
    }
    
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-header {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 {
      font-size: 20px; font-weight: 600; margin: 0;
    }

    .app-nav {
      display: flex;
      background: var(--input-bg);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .nav-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
    }
    .nav-btn:hover {
      color: var(--text);
    }
    .nav-btn.active {
      background: var(--btn-hover);
      color: var(--text);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .card {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h2 {
      font-size: 18px; font-weight: 600; margin: 0 0 8px;
      padding-bottom: 16px; border-bottom: 1px solid var(--border);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px 12px;
      align-items: start;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    label { color: var(--muted); font-size: 13px; font-weight: 500; user-select: none; }
    
    input[type="text"], select {
      width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--input-bg); color: var(--text); font-size: 14px;
      outline: none; transition: all .2s;
    }
    input[type="text"]:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }
    
    button {
      height: 40px; padding: 0 14px; border: 1px solid var(--border); border-radius: 8px;
      background: var(--btn); color: var(--text); cursor: pointer; user-select: none;
      font-size: 14px; font-weight: 500;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      transition: background .15s, transform .05s, box-shadow .2s;
    }
    button:hover { background: var(--btn-hover); }
    button:active { transform: translateY(1px); }
    button:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--focus-ring); }
    button svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    .btn-accent { border-color: var(--accent-border); background: var(--accent-dark); }
    .btn-accent:hover { background: var(--accent-hover); }
    .btn-outline { background: transparent; }
    .btn-icon { padding: 0; width: 40px; flex-shrink: 0; }
    
    .action-group { align-self: end; }
    .button-group { display: flex; gap: 8px; }

    .checkbox-group {
      align-self: end; height: 40px;
      display: flex; align-items: center; justify-content: flex-start;
    }
    .checkbox-group label {
      display: flex; align-items: center; gap: 8px; cursor: pointer;
      color: var(--text); font-size: 14px;
    }
    
    .status-bar {
      margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--border);
    }
    .status { font-size: 13px; color: var(--muted); }
    .pill { font-size: 12px; color: #a7f3d0; background: rgba(16,185,129,.12); border: 1px solid rgba(16,185,129,.35); padding: 3px 8px; border-radius: 999px; font-weight: 500;}

    .canvas-wrap {
      position: relative; width: 100%; overflow: auto; border-radius: 12px; border: 1px solid var(--border);
      background: var(--input-bg);
    }
    canvas { display: block; max-width: 100%; height: auto; margin: auto; }

    .col-1 { grid-column: span 1; } .col-2 { grid-column: span 2; }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; } .col-7 { grid-column: span 7; }
    .col-12 { grid-column: span 12; }
    
    .hidden { display: none !important; }

    @media (max-width: 1024px) {
      .col-lg-2 { grid-column: span 2; } .col-lg-3 { grid-column: span 3; }
      .col-lg-4 { grid-column: span 4; } .col-lg-5 { grid-column: span 5; }
      .col-lg-6 { grid-column: span 6; } .col-lg-12 { grid-column: span 12; }
    }
    @media (max-width: 768px) {
      body { padding: 8px; }
      .app-header { flex-direction: column; align-items: stretch; }
      .controls { grid-template-columns: 1fr; }
      .col-1,.col-2,.col-3,.col-4,.col-5,.col-7,.col-12,
      .col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-12 {
        grid-column: span 1;
      }
      .action-group, .checkbox-group { align-self: stretch; }
      .button-group button { flex: 1; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <header class="app-header">
      <h1 id="main-title">Point-Reader 标注可视化</h1>
      <nav class="app-nav">
        <button id="nav-btn-pr" class="nav-btn active">标注可视化</button>
        <button id="nav-btn-token" class="nav-btn">Token 可视化</button>
      </nav>
    </header>

    <!-- Point-Reader View -->
    <div id="view-pr" class="card">
      <h2>标注可视化 (Point-Reader)</h2>
      <div class="controls">
        <div class="form-group col-3 col-lg-4">
          <label for="sampleInput">样例编号 / 名称</label>
          <input id="sampleInput" type="text" placeholder="例如: 6 / sample_00006" />
        </div>
        <div class="form-group action-group col-3 col-lg-3">
          <div class="button-group">
            <button id="prevBtn" title="上一张" class="btn-icon"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <button id="nextBtn" title="下一张" class="btn-icon"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
            <button id="loadBtn" class="btn-accent" style="flex-grow: 1;">
              <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              加载
            </button>
          </div>
        </div>
        <div class="form-group col-3 col-lg-5">
          <label for="queryInput">搜索文本</label>
          <input id="queryInput" type="text" placeholder="输入需要匹配的字符串" />
        </div>
        <div class="form-group checkbox-group col-1 col-lg-2">
          <label><input id="caseSensitive" type="checkbox" />区分大小写</label>
        </div>
        <div class="form-group action-group col-2 col-lg-4">
          <div class="button-group" style="width: 100%;">
              <button id="toggleModeBtn" class="btn-outline" title="切换绘制模式" style="flex: 1;">
                  <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L20.49 2a9 9 0 0 1-14.85 3.36L3.51 9z"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L3.51 22a9 9 0 0 1 14.85-3.36l2.13 1.36z"></path></svg>
                  切换模式</button>
              <button id="applyBtn" class="btn-accent" title="应用" style="flex: 1;">
                  <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                  应用搜索</button>
          </div>
        </div>
      </div>
      <div class="status-bar">
          <span id="status" class="status">就绪</span>
      </div>
      <div class="canvas-wrap">
        <canvas id="canvas"></canvas>
      </div>
    </div>

    <!-- Token Visualizer View -->
    <div id="view-token" class="card hidden">
      <h2>Token 可视化 (解码 &lt;loc_..&gt;)</h2>
      <div class="controls">
        <div class="form-group col-3 col-lg-4">
          <label for="t_sampleInput">样例编号 / 名称</label>
          <input id="t_sampleInput" type="text" placeholder="例如: 6 / sample_00006" />
        </div>
        <div class="form-group action-group col-3 col-lg-3">
          <div class="button-group">
            <button id="t_prevBtn" title="上一张" class="btn-icon"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <button id="t_nextBtn" title="下一张" class="btn-icon"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
            <button id="t_loadBtn" class="btn-accent" style="flex-grow: 1;">
              <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              加载</button>
          </div>
        </div>
        <div class="form-group col-3 col-lg-5">
          <label for="t_text">任务字符/字符串</label>
          <input id="t_text" type="text" placeholder="例如: ABC 或 A" />
        </div>
        <div class="form-group col-1 col-lg-3">
          <label for="t_task">任务类型</label>
          <select id="t_task">
            <option value="points">points out</option>
            <option value="detect">detect</option>
          </select>
        </div>
        <div class="form-group col-1 col-lg-3">
          <label for="t_mode">解析模式</label>
          <select id="t_mode">
            <option value="auto">自动</option>
            <option value="points">点(每2个token)</option>
            <option value="obb">OBB(每8个token)</option>
          </select>
        </div>
        <div class="form-group checkbox-group col-2 col-lg-2">
          <label><input id="t_showCoords" type="checkbox" /> 显示坐标</label>
        </div>
        <div class="form-group action-group col-12">
          <button id="t_renderBtn" class="btn-accent" title="渲染" style="width: 100%;">
              <svg viewBox="0 0 24 24"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
              渲染 Token
          </button>
        </div>
      </div>
      <div class="status-bar">
        <span id="t_status" class="status">Token 可视化就绪</span>
      </div>
      <div class="canvas-wrap">
        <canvas id="t_canvas"></canvas>
      </div>
    </div>
  </div>


  <script>
    const $ = (id) => document.getElementById(id);

    // =====================================================================
    // ===== VIEW NAVIGATION LOGIC =========================================
    // =====================================================================
    const navBtnPr = $('nav-btn-pr');
    const navBtnToken = $('nav-btn-token');
    const viewPr = $('view-pr');
    const viewToken = $('view-token');
    const mainTitle = $('main-title');

    function switchView(viewName) {
      if (viewName === 'pr') {
        viewPr.classList.remove('hidden');
        viewToken.classList.add('hidden');
        navBtnPr.classList.add('active');
        navBtnToken.classList.remove('active');
        mainTitle.textContent = 'Point-Reader 标注可视化';
      } else {
        viewPr.classList.add('hidden');
        viewToken.classList.remove('hidden');
        navBtnPr.classList.remove('active');
        navBtnToken.classList.add('active');
        mainTitle.textContent = 'Token 序列可视化';
      }
    }

    navBtnPr.addEventListener('click', () => switchView('pr'));
    navBtnToken.addEventListener('click', () => switchView('token'));


    // =====================================================================
    // ===== POINT-READER VISUALIZER LOGIC =================================
    // =====================================================================
    function debounce(fn, delay = 120) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), delay);
      };
    }

    const state = {
      baseName: 'sample_00000',
      index: 0,
      drawMode: 'center', // 'center' | 'bbox'
      image: null,
      json: null,
    };

    function pad5(n) { return String(n).padStart(5, '0'); }

    function normalizeSample(input) {
      let s = (input || '').trim();
      if (!s) return { base: state.baseName, index: state.index };
      s = s.replace(/\.(json|png)$/i, '');
      if (!s.startsWith('sample_')) {
        if (/^\d+$/.test(s)) {
          s = 'sample_' + pad5(parseInt(s, 10));
        } else {
          s = 'sample_' + s;
        }
      }
      const m = s.match(/sample_(\d{1,})$/);
      const idx = m ? parseInt(m[1], 10) : state.index;
      return { base: s, index: idx };
    }

    async function loadSample(baseName) {
      const imgPath = `output/images/${baseName}.png`;
      const jsonPath = `output/annotations/${baseName}.json`;
      $('status').textContent = `加载中: ${baseName} ...`;
      try {
        const [img, meta] = await Promise.all([
          loadImage(imgPath),
          fetch(jsonPath).then(r => { if (!r.ok) throw new Error(`无法读取 ${jsonPath}`); return r.json(); })
        ]);
        state.image = img;
        state.json = meta;
        state.baseName = baseName;
        const m = baseName.match(/sample_(\d{1,})$/);
        state.index = m ? parseInt(m[1], 10) : state.index;
        $('sampleInput').value = baseName;
        draw();
        $('status').innerHTML = `已加载 <span class="pill">${baseName}</span>，图像尺寸 ${img.naturalWidth}×${img.naturalHeight}，共有子串 ${meta.substrings?.length ?? 0} 个`;
        
        // Also sync to the token visualizer
        tState.image = img;
        tState.baseName = baseName;
        tState.index = state.index;
        $('t_sampleInput').value = baseName;
        tDraw(); // Redraw token canvas with new image but old tokens
        $('t_status').innerHTML = `已从另一视图同步 <span class="pill">${baseName}</span>`;

      } catch (err) {
        console.error(err);
        $('status').textContent = err.message || String(err);
      }
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error(`无法加载图片: ${src}`));
        img.src = src + `?t=${Date.now()}`;
      });
    }

    function draw() {
      const canvas = $('canvas');
      const ctx = canvas.getContext('2d');
      if (!state.image) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
      canvas.width = state.image.naturalWidth;
      canvas.height = state.image.naturalHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(state.image, 0, 0);

      const query = $('queryInput').value.trim();
      if (!query || !state.json) return;
      const caseSensitive = $('caseSensitive').checked;
      const subs = Array.isArray(state.json.substrings) ? state.json.substrings : [];
      const match = (t) => caseSensitive ? (t === query) : (String(t).toLowerCase() === query.toLowerCase());
      const matches = subs.filter(s => match(s.text));

      const color = '#22c55e';
      const dash = [6, 4];
      ctx.save();
      ctx.lineWidth = 2;
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.setLineDash(dash);

      let totalCharPts = 0;

      for (const m of matches) {
         if (state.drawMode === 'bbox') {
           const obb = m.obb;
           if (Array.isArray(obb) && obb.length === 4 && obb.every(pt => Array.isArray(pt) && pt.length === 2 && pt.every(Number.isFinite))) {
             drawPolygon(ctx, obb, color);
             const [cx, cy] = computeCentroid(obb);
             drawTag(ctx, m.text, cx, cy, color, true);
           } else {
             const [x1, y1, x2, y2] = m.bbox || [];
             if ([x1,y1,x2,y2].every(Number.isFinite)) {
               ctx.strokeRect(x1 + 0.5, y1 + 0.5, (x2 - x1), (y2 - y1));
               drawTag(ctx, m.text, x1, y1, color);
             }
           }
         } else {
           const ccs = Array.isArray(m.char_centers) ? m.char_centers : [];
           if (ccs.length > 0) {
             ccs.forEach(pt => {
               const [x, y] = pt;
               if ([x, y].every(Number.isFinite)) drawDot(ctx, x, y, color);
             });
             const sum = ccs.reduce((acc, pt) => [acc[0] + pt[0], acc[1] + pt[1]], [0, 0]);
             const cx = sum[0] / ccs.length, cy = sum[1] / ccs.length;
             drawTag(ctx, m.text, cx, cy, color, true);
             totalCharPts += ccs.length;
           } else {
             const [cx, cy] = m.center || [];
             if ([cx, cy].every(Number.isFinite)) {
               drawDot(ctx, cx, cy, color);
               drawTag(ctx, m.text, cx + 8, cy - 8, color, true);
               totalCharPts += 1;
             }
           }
         }
       }
      ctx.restore();

      if (query) {
        $('status').innerHTML = state.drawMode === 'center'
          ? `已加载 <span class="pill">${state.baseName}</span>，匹配到 ${matches.length} 个，字符点 ${totalCharPts} 个`
          : `已加载 <span class="pill">${state.baseName}</span>，匹配到 ${matches.length} 个`;
      }
    }

    function drawTag(ctx, text, x, y, color = '#22c55e', centered = false) {
      const padX = 6, padY = 4;
      ctx.save();
      ctx.setLineDash([]);
      ctx.font = '12px ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial';
      const metrics = ctx.measureText(text);
      const w = metrics.width + padX * 2;
      const h = 16 + padY * 2;
      let tx = x, ty = y;
      if (centered) { tx = x - w/2; ty = y - h/2; }
      ctx.fillStyle = 'rgba(2,6,23,0.7)';
      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      roundRect(ctx, tx, ty - h, w, h, 6);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = color;
      ctx.fillText(text, tx + padX, ty - h + padY + 12);
      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r) {
      const min = Math.min(w, h) / 2; r = Math.min(r, min);
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function drawPolygon(ctx, points, color = '#22c55e') {
      ctx.save();
      ctx.setLineDash([6,4]);
      ctx.lineWidth = 2;
      ctx.strokeStyle = color;
      ctx.beginPath();
      ctx.moveTo(points[0][0] + 0.5, points[0][1] + 0.5);
      for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i][0] + 0.5, points[i][1] + 0.5);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.restore();
    }

    function computeCentroid(points) {
      let sx = 0, sy = 0;
      for (const [x,y] of points) { sx += x; sy += y; }
      return [sx / points.length, sy / points.length];
    }

    function applySearch() { draw(); }

    function toggleMode() {
      state.drawMode = state.drawMode === 'center' ? 'bbox' : 'center';
      const btn = $('toggleModeBtn');
      btn.childNodes[1].nodeValue = state.drawMode === 'center' ? ' 切换为BBox' : ' 切换为中心点';
      draw();
    }

    function prevSample() {
      const idx = Math.max(0, state.index - 1);
      const base = 'sample_' + pad5(idx);
      loadSample(base);
    }

    function nextSample() {
      const idx = state.index + 1;
      const base = 'sample_' + pad5(idx);
      loadSample(base);
    }

    function onLoadClick() {
      const { base } = normalizeSample($('sampleInput').value);
      loadSample(base);
    }

    const debouncedDraw = debounce(draw, 120);

    $('loadBtn').addEventListener('click', onLoadClick);
    $('applyBtn').addEventListener('click', applySearch);
    $('toggleModeBtn').addEventListener('click', toggleMode);
    $('prevBtn').addEventListener('click', prevSample);
    $('nextBtn').addEventListener('click', nextSample);
    $('queryInput').addEventListener('input', debouncedDraw);
    $('queryInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') applySearch(); });
    $('caseSensitive').addEventListener('change', draw);
    $('sampleInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') onLoadClick(); });

    
    // =====================================================================
    // ===== TOKEN VISUALIZER LOGIC ========================================
    // =====================================================================
    const LOC_RE = /<loc_(\d+)>/g;
    const BINS_W = 1000, BINS_H = 1000;

    const tState = {
      baseName: 'sample_00000',
      index: 0,
      image: null,
      tokensRaw: ''
    };

    function tSplitSegments(str) {
      if (!str) return [];
      return str.split(/(?:<sep>|<spe>)/).map(s => s.trim()).filter(Boolean);
    }

    function tDecodePointsFromTokens(segmentStr, width, height) {
      const ids = [];
      const matches = segmentStr.matchAll(LOC_RE);
      for (const m of matches) ids.push(parseInt(m[1], 10));
      const pts = [];
      for (let i = 0; i + 1 < ids.length; i += 2) {
        const qx = ids[i], qy = ids[i + 1];
        const x = (qx + 0.5) / BINS_W * width;
        const y = (qy + 0.5) / BINS_H * height;
        pts.push([x, y]);
      }
      return { ids, pts };
    }

    function drawDot(ctx, x, y, color = '#22c55e') {
      ctx.save();
      ctx.setLineDash([]);
      ctx.fillStyle = color;
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y, 3.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
    }

    function tDraw() {
      const canvas = $('t_canvas');
      const ctx = canvas.getContext('2d');
      if (!tState.image) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }
      canvas.width = tState.image.naturalWidth;
      canvas.height = tState.image.naturalHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tState.image, 0, 0);

      const raw = tState.tokensRaw || '';
      const segs = tSplitSegments(raw);
      if (segs.length === 0) return;

      const mode = $('t_mode').value;
      const showCoords = $('t_showCoords').checked;
      const colors = ['#22c55e', '#60a5fa', '#f97316', '#e879f9', '#f43f5e', '#14b8a6', '#a3e635', '#f59e0b'];

      ctx.save();
      const segPointCounts = [];
      segs.forEach((seg, si) => {
        const { ids, pts } = tDecodePointsFromTokens(seg, canvas.width, canvas.height);
        const color = colors[si % colors.length];
        const isObb = (mode === 'obb') || (mode === 'auto' && ids.length >= 8 && ids.length % 8 === 0);
        if (isObb) {
          for (let k = 0; k + 7 < ids.length; k += 8) {
            const subPts = pts.slice(k / 2, k / 2 + 4);
            drawPolygon(ctx, subPts.map(p => [p[0], p[1]]), color);
            const [cx, cy] = computeCentroid(subPts);
            drawTag(ctx, `seg${si + 1}`, cx, cy, color, true);
            if (showCoords) {
              subPts.forEach(([x, y], idx) => drawTag(ctx, `${idx + 1}: ${x.toFixed(1)},${y.toFixed(1)}`, x + 8, y - 8, color));
            }
          }
          segPointCounts.push(Math.floor(ids.length / 2));
        } else {
          pts.forEach(([x, y]) => {
            drawDot(ctx, x, y, color);
            if (showCoords) drawTag(ctx, `${x.toFixed(1)},${y.toFixed(1)}`, x + 8, y - 8, color);
          });
          segPointCounts.push(pts.length);
        }
      });
      ctx.restore();

      const tokenCount = segs.reduce((s, seg) => s + ((seg.match(LOC_RE) || []).length), 0);
      const ptsCount = segPointCounts.reduce((a,b)=>a+b,0);
      $('t_status').textContent = `已渲染 ${segs.length} 段；Token 数 ${tokenCount}；点数 ${ptsCount}`;
    }

    async function tLoadSample(baseName) {
      const imgPath = `output/images/${baseName}.png`;
      $('t_status').textContent = `加载中: ${baseName} ...`;
      try {
        const img = await loadImage(imgPath);
        tState.image = img;
        tState.baseName = baseName;
        const m = baseName.match(/sample_(\d{1,})$/);
        tState.index = m ? parseInt(m[1], 10) : tState.index;
        $('t_sampleInput').value = baseName;
        tDraw();
        $('t_status').innerHTML = `已加载 <span class="pill">${baseName}</span>，图像尺寸 ${img.naturalWidth}×${img.naturalHeight}`;

        // Also sync to the point-reader visualizer
        state.image = img;
        state.baseName = baseName;
        state.index = tState.index;
        $('sampleInput').value = baseName;
        const jsonPath = `output/annotations/${baseName}.json`;
        try {
            const meta = await fetch(jsonPath).then(r => r.ok ? r.json() : null);
            state.json = meta;
        } catch(e) { state.json = null; }
        draw(); // Redraw point-reader canvas
        if (state.json) {
            $('status').innerHTML = `已从另一视图同步 <span class="pill">${baseName}</span>`;
        }
        
      } catch (err) {
        console.error(err);
        $('t_status').textContent = err.message || String(err);
      }
    }

    function tPrev() {
      const idx = Math.max(0, tState.index - 1);
      const base = 'sample_' + pad5(idx);
      tLoadSample(base);
    }

    function tNext() {
      const idx = tState.index + 1;
      const base = 'sample_' + pad5(idx);
      tLoadSample(base);
    }

    function tOnLoadClick() {
      const { base } = normalizeSample($('t_sampleInput').value);
      tLoadSample(base);
    }



    const tDebouncedDraw = debounce(tDraw, 150);

    async function tRequestAndRenderFromPrompt() {
      if (!tState.image) {
        $('t_status').textContent = '请先加载样例图片';
        return;
      }
      const text = ($('t_text').value || '').trim();
      const task = ($('t_task').value || 'points').trim();
      if (!text) {
        $('t_status').textContent = '请输入字符/字符串';
        return;
      }
      const prompt = task === 'detect' ? `detect ${text}` : `points out ${text}`;
      const baseName = tState.baseName || 'sample_00000';
      const imgPath = `output/images/${baseName}.png`;
      try {
        $('t_status').textContent = `正在调用任务: ${prompt}`;
        const imgResp = await fetch(imgPath);
        if (!imgResp.ok) throw new Error(`无法读取图片: ${imgPath}`);
        const blob = await imgResp.blob();
        const b64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error('图片读取失败'));
          reader.onloadend = () => {
            const dataUrl = String(reader.result || '');
            const base64 = dataUrl.split(',')[1] || '';
            resolve(base64);
          };
          reader.readAsDataURL(blob);
        });

        const resp = await fetch('http://172.20.253.222:20070/point-reader', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image_base64: b64, prompt })
        });
        if (!resp.ok) throw new Error(`API 请求失败: ${resp.status}`);
        const json = await resp.json();
        const gen = (json && json.data && json.data.generated_text) ? json.data.generated_text : '';
        tState.tokensRaw = gen || '';
        tDraw();
      } catch (err) {
        console.error(err);
        $('t_status').textContent = err.message || String(err);
      }
    }

    $('t_loadBtn').addEventListener('click', tOnLoadClick);
    $('t_renderBtn').addEventListener('click', tRequestAndRenderFromPrompt);
    $('t_prevBtn').addEventListener('click', tPrev);
    $('t_nextBtn').addEventListener('click', tNext);
    /* 原先的 t_tokens 输入事件不再需要 */
    $('t_mode').addEventListener('change', tDraw);
    $('t_showCoords').addEventListener('change', tDraw);
    $('t_sampleInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') tOnLoadClick(); });
    

    // =====================================================================
    // ===== INITIALIZATION ================================================
    // =====================================================================
    (function init() {
      // Init Point-Reader
      const { base, index } = normalizeSample('00000');
      state.index = index; state.baseName = base;
      $('sampleInput').value = base;
      loadSample(base).catch(() => {
        $('status').textContent = '请在上方输入样例编号或名称后点击加载';
      });
      const btn = $('toggleModeBtn');
      btn.childNodes[1].nodeValue = state.drawMode === 'center' ? ' 切换为BBox' : ' 切换为中心点';
      
      // Init Token Vis (it will be synced by loadSample)
      $('t_sampleInput').value = base;
    })();

  </script>
</body>
</html>